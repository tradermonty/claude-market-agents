# Claude Market Agents

An automated US stock market analysis and report generation system powered by Claude Code and MCP (Model Context Protocol) servers.

## Overview

This project provides automated trading analysis workflows using Claude Code's agent system. It generates comprehensive market reports, earnings trade analysis, and social media content through scheduled cron jobs or manual execution.

## Features

### Automated Agents

| Agent | Description |
|-------|-------------|
| `earnings-trade-analyst` | Analyzes post-earnings momentum plays with scoring system |
| `after-market-reporter` | Generates daily market summary after US market close |
| `market-environment-strategist` | Comprehensive market environment and regime analysis |
| `fmp-stock-analyzer` | Individual stock fundamental and technical analysis |
| `earnings-analysis-reporter` | Detailed earnings report analysis |

### MCP Server Integrations

- **Alpaca** - Real-time and historical stock market data
- **Finviz** - Stock screening, fundamentals, and market overview
- **FMP (Financial Modeling Prep)** - Financial statements, estimates, analyst ratings
- **Puppeteer** - Web automation and screenshot capture

## Project Structure

```
claude-market-agents/
├── backtest/             # Earnings trade backtest engine
│   ├── main.py           # CLI entry point
│   ├── html_parser.py    # Parse earnings trade HTML reports
│   ├── price_fetcher.py  # Fetch historical OHLCV data (FMP API)
│   ├── trade_simulator.py # Simulate trades with stop loss / trailing stop
│   ├── weekly_bars.py    # Weekly bar aggregation and trend detection
│   ├── metrics_calculator.py # Win rate, Sharpe, drawdown, etc.
│   ├── report_generator.py   # HTML backtest report output
│   ├── chart_generator.py    # Equity curve and trade charts
│   ├── portfolio_simulator.py # Multi-position portfolio simulation
│   ├── walk_forward.py   # Walk-forward (expanding window) validation
│   ├── trailing_stop_experiment.py # Parameter sweep for trailing stops
│   └── tests/            # Unit tests
├── live/                 # Live paper trading system (Alpaca API)
│   ├── config.py         # Frozen trading parameters (must match backtest manifest)
│   ├── signal_generator.py # Generate entry/exit signals from reports
│   ├── executor.py       # Order execution pipeline (OPG / day orders)
│   ├── alpaca_client.py  # Alpaca REST API wrapper
│   ├── trailing_stop_checker.py # Weekly trailing stop evaluation
│   ├── state_db.py       # SQLite state tracking for orders and positions
│   └── tests/            # Unit tests
├── .claude/
│   ├── agents/           # Agent definitions
│   └── settings.local.json  # Permission configurations
├── prompts/              # Detailed prompt instructions for each agent
├── reports/              # Generated HTML reports and social media posts (gitignored)
├── scripts/              # Cron automation scripts
├── logs/                 # Execution logs (gitignored)
├── CLAUDE.md             # Claude Code project configuration
└── .mcp.json             # MCP server configurations (gitignored)
```

## Installation

### Prerequisites

- Claude Code CLI installed (`claude`)
- Node.js 18+ (for Puppeteer MCP server)
- Python 3.10+ (for MCP servers)
- API keys for:
  - Alpaca (trading data)
  - Finviz Elite (screening)
  - Financial Modeling Prep (fundamentals)

### Setup

1. Clone the repository:
```bash
git clone <repository-url>
cd claude-market-agents
```

2. Install Python dependencies:
```bash
pip install -e ".[dev]"
```

3. Configure MCP servers in `.mcp.json` with your API keys

## Backtest

Earnings gap-up trade strategy backtester. Parses HTML reports generated by the `earnings-trade-analyst` agent, fetches historical price data, and simulates trades.

```bash
# Basic run
python -m backtest.main --reports-dir reports/ --output-dir reports/backtest/

# Custom parameters
python -m backtest.main \
  --position-size 10000 \
  --stop-loss 10 \
  --stop-mode intraday \
  --entry-mode report_open \
  --trailing-stop weekly_ema \
  --trailing-ema-period 10 \
  --min-grade D
```

Key features:
- **Stop modes**: `intraday` (low-based), `close` (close-based), `skip_entry_day`, `close_next_open`
- **Trailing stops**: Weekly EMA or N-week low based trend exits
- **Walk-forward validation**: Expanding window out-of-sample testing to prevent overfitting
- **Portfolio simulation**: Multi-position sizing with daily capital tracking

## Live Trading

Paper trading system using Alpaca API. Generates signals from earnings reports and executes OPG (Market-on-Open) orders.

```bash
# Generate trade signals
python -m live.signal_generator --report reports/earnings_trade_analysis_2026-02-14.html

# Execute orders (OPG pre-market)
python -m live.executor --signals-file signals.json --phase place --dry-run

# Poll for order fills
python -m live.executor --state-db live/state.db --phase poll
```

Execution pipeline phases:
1. **A**: Cancel existing stops + sell exits
2. **B**: Poll sell orders until filled
3. **C**: Recount positions
4. **D**: Buy entries + place protective stops
5. **E**: Poll buy orders until filled

Configuration in `live/config.py` is frozen and must match the backtest `run_manifest.json` to ensure consistency between backtested and live parameters.

## Usage

### Manual Execution

Run agents directly with Claude Code:

```bash
# Earnings Trade Analysis
claude -p "Run the earnings trade analysis using the earnings-trade-analyst agent"

# After Market Report
claude -p "Generate today's after-market report using the after-market-reporter agent"

# Market Environment Analysis
claude -p "Analyze current market environment using the market-environment-strategist agent"
```

### Automated Cron Jobs

Schedule automatic report generation:

```bash
# Edit crontab
crontab -e

# Add entries (US Pacific Time)
# Earnings Trade Report - 6:00 AM PT (Mon-Fri)
0 6 * * 1-5 /path/to/claude-market-agents/scripts/run_earnings_trade_report.sh

# After Market Report - 1:10 PM PT (Mon-Fri)
10 13 * * 1-5 /path/to/claude-market-agents/scripts/run_after_market_report.sh
```

See `scripts/README.md` for detailed cron setup instructions.

## Output

### Reports Directory

Generated files are saved to `reports/`:

| File Pattern | Description |
|--------------|-------------|
| `earnings_trade_analysis_YYYY-MM-DD.html` | Earnings trade analysis infographic |
| `earnings_trade_X_message_YYYY-MM-DD.md` | Twitter/X post for earnings trades |
| `after_market_report_YYYY_MM_DD.html` | Daily market summary infographic |
| `after_market_report_x_post_YYYY-MM-DD.md` | Twitter/X post for market summary |

### Log Files

Execution logs are saved to `logs/`:
- `earnings_trade_YYYY-MM-DD.log`
- `after_market_YYYY-MM-DD.log`

## Configuration

### CLAUDE.md

Project-level Claude Code configuration for pre-approved tools and permissions.

### settings.local.json

Local permission settings including:
- Allowed tools and MCP server functions
- File read/write permissions
- Bash command allowlist

## Market Hours Reference

| Event | Eastern Time | Pacific Time |
|-------|--------------|--------------|
| Pre-market Open | 4:00 AM | 1:00 AM |
| Market Open | 9:30 AM | 6:30 AM |
| Market Close | 4:00 PM | 1:00 PM |
| After-hours Close | 8:00 PM | 5:00 PM |

## Troubleshooting

### Permission Errors

If Claude Code reports permission errors:
1. Check `settings.local.json` has necessary permissions
2. Use `--dangerously-skip-permissions` flag for automated runs
3. Verify MCP servers are running

### No Output Generated

1. Check log files in `logs/` directory
2. Verify API keys are valid and have sufficient quota
3. Ensure market data is available (weekdays only)

### MCP Server Issues

```bash
# Test MCP server connectivity
claude -p "Test connection to Finviz MCP server by running get_market_overview"
```

## Development

### Running Tests

```bash
# All tests
pytest

# With coverage
pytest --cov=backtest --cov=live --cov-report=term-missing

# Specific module
pytest backtest/tests/test_trade_simulator.py -v
```

### Linting and Type Checking

```bash
ruff check .          # Lint
ruff format --check . # Format check
ruff format .         # Auto-format
mypy backtest/ live/  # Type check
codespell backtest/ live/  # Spell check
```

### CI

Pull requests run the **PR Quality Gate** workflow with 5 parallel jobs:

| Job | Tools | Required |
|-----|-------|----------|
| Lint | ruff, codespell | Yes |
| Type Check | mypy | Yes |
| Unit Tests | pytest (Python 3.10 + 3.12) | Yes |
| Security Scan | bandit, pip-audit | Yes |
| Code Quality | vulture, deptry | No (advisory) |

### Pre-commit Hooks

```bash
pre-commit install
pre-commit install --hook-type pre-push
```

- **pre-commit**: trailing whitespace, EOF fixer, YAML/TOML check, ruff lint + format
- **pre-push**: mypy type check, quick test suite

## License

Private project - All rights reserved

## Contributing

Internal use only. Contact the repository owner for contribution guidelines.
