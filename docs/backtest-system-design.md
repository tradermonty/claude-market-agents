# Backtest System Design

## 1. Overview

The `backtest/` package validates an earnings gap-up trade scoring system by simulating historical trades and measuring strategy profitability. The end-to-end flow is:

1. **Input**: HTML reports generated by the `earnings-trade-analyst` agent, each containing scored trade candidates.
2. **Price Data**: Historical daily OHLCV bars fetched from the FMP (Financial Modeling Prep) API, split-adjusted.
3. **Simulation**: Trades are simulated using configurable entry, exit, and risk-management rules.
4. **Output**: HTML reports with interactive Plotly charts, CSV trade logs, and a reproducibility manifest.

Two simulation modes are available:

| Mode | Module | Description |
|------|--------|-------------|
| **Independent Trade** | `TradeSimulator` | Each trade is simulated in isolation; no capacity constraints. |
| **Portfolio** | `PortfolioSimulator` | Day-by-day simulation with concurrent position limits, duplicate prevention, and position rotation. |

---

## 2. Architecture — Logical Pipeline

The pipeline follows the step numbering logged by `main.py`:

```
Step 1: Parse       HTML reports → TradeCandidate list
        Filter      grade / score / gap filtering (pre-fetch)
Step 2: Fetch       Historical OHLCV via FMP API (split-adjusted)
Step 3: Simulate    Independent or Portfolio mode
Step 4: Metrics     Compute performance metrics
Step 5: Report      HTML + CSV + run_manifest.json
Step 6: Charts      (optional, --charts) Candlestick PNGs per trade
Step 7: Walk-Fwd    (optional, --walk-forward) Expanding-window validation
                    ⚠ Not supported in Portfolio mode
```

Filtering (grade, score range, gap size) happens between Parse and Fetch in `main.py` (lines 256-280). It is not a separate pipeline stage but rather pre-fetch candidate pruning.

---

## 3. Data Model

### TradeCandidate (`html_parser.py`)

| Field | Type | Description |
|-------|------|-------------|
| `ticker` | `str` | Stock symbol |
| `report_date` | `str` | YYYY-MM-DD extracted from HTML filename |
| `grade` | `str` | A/B/C/D quality grade |
| `grade_source` | `str` | `"html"` (from report) or `"inferred"` (from score) |
| `score` | `Optional[float]` | 0-100 composite score; None if only grade available |
| `price` | `Optional[float]` | Stock price at report time |
| `gap_size` | `Optional[float]` | Earnings gap-up percentage |
| `company_name` | `Optional[str]` | Company name |

### PriceBar (`price_fetcher.py`)

| Field | Type | Description |
|-------|------|-------------|
| `date` | `str` | YYYY-MM-DD |
| `open` / `high` / `low` / `close` | `float` | Raw OHLC prices |
| `adj_close` | `Optional[float]` | Split/dividend-adjusted close from FMP |
| `volume` | `int` | Daily volume |

Computed properties:
- `adj_factor` → `adj_close / close` (1.0 if unavailable)
- `adjusted_open` / `adjusted_high` / `adjusted_low` → raw price × `adj_factor`

### WeeklyBar (`weekly_bars.py`)

| Field | Type | Description |
|-------|------|-------------|
| `week_ending` | `str` | Last trading day of the ISO week |
| `week_start` | `str` | First trading day of the ISO week |
| `open` | `float` | First bar's `adjusted_open` |
| `high` | `float` | Max `adjusted_high` across the week |
| `low` | `float` | Min `adjusted_low` across the week |
| `close` | `float` | Last bar's `adj_close` |
| `volume` | `int` | Sum of daily volumes |

### TradeResult (`trade_simulator.py`)

| Field | Type | Description |
|-------|------|-------------|
| `ticker` | `str` | Stock symbol |
| `grade` / `grade_source` | `str` | Inherited from candidate |
| `score` | `Optional[float]` | Inherited from candidate |
| `report_date` | `str` | Original report date |
| `entry_date` / `entry_price` | `str` / `float` | Entry execution details (adjusted open) |
| `exit_date` / `exit_price` | `str` / `float` | Exit execution details |
| `shares` | `int` | `floor(position_size / entry_price)` |
| `invested` | `float` | `shares * entry_price` |
| `pnl` | `float` | `(exit_price - entry_price) * shares` |
| `return_pct` | `float` | Percentage return |
| `holding_days` | `int` | Calendar days held |
| `exit_reason` | `str` | `"stop_loss"` / `"max_holding"` / `"end_of_data"` / `"trend_break"` / `"rotated_out"` |
| `gap_size` | `Optional[float]` | Inherited from candidate |

### SkippedTrade (`trade_simulator.py`)

| Field | Type | Description |
|-------|------|-------------|
| `ticker` / `report_date` / `grade` / `score` | — | Candidate identity |
| `skip_reason` | `str` | `"no_price_data"` / `"zero_shares"` / `"missing_ohlc"` / `"daily_limit"` / `"capacity_full"` / `"duplicate_ticker"` |

### BacktestMetrics (`metrics_calculator.py`)

See section 8 for full metrics description. Key fields: `total_trades`, `win_rate`, `total_pnl`, `profit_factor`, `trade_sharpe`, `max_drawdown`, `max_drawdown_pct`, `peak_positions`, `capital_requirement`, plus grade/score/gap/monthly breakdowns and statistical tests.

---

## 4. HTML Parser

`EarningsReportParser` handles multiple HTML layout variants generated over time by the `earnings-trade-analyst` agent.

**Extraction strategy** — each field uses a fallback chain of regex patterns and DOM selectors:

| Field | Primary | Fallback(s) |
|-------|---------|-------------|
| Ticker | CSS class / `<td>` text | Regex `$TICKER` from surrounding text |
| Score | `"XX pts"` / `"XX/100"` pattern | Element-level `5/5` scoring extraction |
| Grade | CSS class `grade-a` etc. | Text pattern `"A-Grade"`, single letter `[ABCD]` |
| Price | `$XX.XX` pattern | — |
| Gap | Percentage from gap column/text | — |

**Grade inference**: When HTML provides a score but no explicit grade, a grade is inferred from the score and tagged `grade_source="inferred"`.

**Deduplication**: Candidates are deduplicated by `(report_date, ticker)`. When duplicates exist, the entry with an actual score is preferred over one without.

---

## 5. Trade Simulation — Independent Mode (`TradeSimulator`)

### Entry

| Mode | Flag | Behavior |
|------|------|----------|
| `report_open` | `--entry-mode report_open` | Enter at the open of the report date (or next trading day if report date is not a trading day) |
| `next_day_open` | `--entry-mode next_day_open` | Enter at the open of the first trading day after report date |

Position sizing: `shares = floor(position_size / adjusted_open)`.

### Stop Loss Modes

| Mode | `--stop-mode` | Trigger | Exit Price |
|------|--------------|---------|------------|
| `intraday` | `intraday` | `adjusted_low <= stop_price` | `stop_price * (1 - slippage%)` |
| `close` | `close` | `adj_close <= stop_price` | `adj_close * (1 - slippage%)` |
| `skip_entry_day` | `skip_entry_day` | Same as `intraday` but skipped on entry day (idx > 0) | `stop_price * (1 - slippage%)` |
| `close_next_open` | `close_next_open` | `adj_close <= stop_price` → sets `pending_exit` | Next bar's `adjusted_open * (1 - slippage%)` |

Where `stop_price = entry_price * (1 - stop_loss_pct / 100)`.

### Trailing Stops

| Mode | `--trailing-stop` | Indicator |
|------|-------------------|-----------|
| Weekly EMA | `weekly_ema` | EMA of weekly close prices (`--trailing-ema-period`, default 10) |
| Weekly N-week Low | `weekly_nweek_low` | Minimum low of previous N weeks (`--trailing-nweek-period`, default 4) |

Activation gate: trailing stop only activates after `--trailing-transition-weeks` (default 3) completed weeks post-entry.

Trend break detection: if weekly `close < indicator` at week-end → sets `pending_exit = "trend_break"` → executes at next bar's open with slippage.

### Exit Priority

On each bar, checks are evaluated in this order:

1. **Pending exit** — if a previous day set `pending_exit`, exit at today's open
2. **Stop loss** — mode-dependent check (may set `pending_exit` for `close_next_open`)
3. **Trailing stop** — checked at week-end only; sets `pending_exit` if triggered
4. **Max holding** — if `calendar_days >= max_holding_days`, exit at close
5. **End of data** — if the loop completes without exit, close at last bar's close

### Daily Entry Limit

`--daily-entry-limit N`: candidates are grouped by entry date, ranked by score descending, and only the top N per day are simulated. Others are skipped with reason `"daily_limit"`.

### Safety Invariant

At least one exit mechanism is required. If both `--trailing-stop` and `--max-holding` are disabled (`--disable-max-holding` without `--trailing-stop`), the constructor raises `ValueError`.

---

## 6. Trade Simulation — Portfolio Mode (`PortfolioSimulator`)

Enabled by `--max-positions N`. Simulates all positions concurrently on a day-by-day basis.

### Daily Processing Phases

Each trading day proceeds through 5 intraday phases:

| # | Phase | Timing | Action |
|---|-------|--------|--------|
| 1 | Pending exits | Open | Process positions with `pending_exit` at today's open (with slippage) |
| 2 | New entries | Open | Enter new candidates (score-ranked, highest first) |
| 3 | Stop loss | Intraday | Check stop loss on all open positions |
| 4 | Trailing stop | Close | Check trailing stop at week-end only; sets `pending_exit` |
| 5 | Max holding | Close | Close positions exceeding `max_holding_days` at close |

### Capacity and Rotation

- **`max_positions`**: Maximum concurrent open positions. Excess candidates are skipped with `"capacity_full"`.
- **Position rotation** (default on, disable with `--no-rotation`): When at capacity and a new candidate has a higher score than the weakest open position (most negative unrealized P&L), the weakest position is rotated out at today's open. Maximum 1 rotation per day.
- **Duplicate ticker prevention**: A candidate is skipped if its ticker is already held in an open position.

### PriceDateIndex

`PriceDateIndex` provides O(1) bar lookup by `(ticker, date)` for efficient day-by-day simulation. It pre-indexes all bars at construction time and provides:
- `get_bar(ticker, date)` — single bar lookup
- `get_previous_close(ticker, date)` — for unrealized P&L calculation
- `all_trading_dates()` — sorted union of all dates across tickers
- `get_bars_up_to(ticker, date)` — for trailing stop weekly aggregation

### Limitation

Walk-forward validation is **not supported** in Portfolio mode. If `--walk-forward` is specified with `--max-positions`, a warning is logged and walk-forward is skipped (`main.py:442-443`).

---

## 7. Weekly Bars & Trailing Stop

### Weekly Aggregation

Daily bars are grouped by ISO `(year, week)` into `WeeklyBar` records. Partial weeks (due to holidays or short trading weeks) are valid bars. Adjusted prices are used throughout.

### EMA Computation

- First `period` bars: SMA seed (`sum(close[0:period]) / period`)
- Subsequent bars: `EMA = close * k + prev_EMA * (1 - k)` where `k = 2 / (period + 1)`
- Returns `None` for indices `< period` (insufficient data)

### N-week Low Computation

- For index `i`, returns `min(low)` of `weekly_bars[max(0, i-period):i]`
- The current week (index `i`) is **excluded** to avoid the trivial condition where `close < low` is always false within the same week
- Returns `None` when `i < period` (full window required)

### Trend Break Detection

`is_trend_broken()`: Finds the most recent completed weekly bar (where `week_ending <= current_date`) and checks if `weekly_close < indicator_value`. Works identically for both EMA and N-week low indicators.

### Completed Week Counting

`count_completed_weeks(weekly_bars, entry_date, current_date)`: Counts weekly bars where `week_start > entry_date` and `week_ending <= current_date`. The entry week is always excluded (even if entry falls on the week's start date) to ensure only full post-entry weeks are counted toward the transition period.

---

## 8. Metrics

### Overall Metrics

| Metric | Description |
|--------|-------------|
| Win Rate | `wins / total_trades * 100` |
| Total P&L | Sum of all trade P&L |
| Avg / Median Return | Mean and median of `return_pct` |
| Profit Factor | `total_profit / total_loss` (inf if no losses) |
| Trade Sharpe | `mean(returns) / std(returns, ddof=1)` |
| Max Drawdown ($) | Peak-to-trough of cumulative P&L (entry-date ordered) |
| Max Drawdown (%) | Same, expressed as percentage of peak equity |

### Breakdown Dimensions

| Dimension | Description |
|-----------|-------------|
| **Grade** (A/B/C/D) | Win rate, P&L, avg/median return, stop loss rate, avg holding days (win/loss/stop). Two versions: all grades and HTML-sourced only. |
| **Score Range** | Buckets: 85+, 70-84, 55-69, <55. Win rate, avg return, total P&L. |
| **Gap Size** | Buckets: 0-5%, 5-10%, 10-20%, 20%+, Unknown. |
| **Cross Filter** (Gap x Score) | Matrix of gap size ranges vs. score ranges. |
| **Monthly** | YYYY-MM breakdown of trade count, win rate, P&L, avg return. |

### Statistical Tests

| Test | Description |
|------|-------------|
| **Pearson correlation** | Score vs. return percentage (excludes trades without scores) |
| **Welch t-test** | A/B grade returns vs. C/D grade returns (HTML-sourced grades only, `grade_source="html"`) |

### Equity Curve

`daily_equity`: Daily time series from first entry to last exit, tracking cumulative realized P&L and open position count (based on entry/exit date deltas).

### Portfolio-Specific Metrics

| Metric | Description |
|--------|-------------|
| `peak_positions` | Maximum concurrent open positions observed |
| `capital_requirement` | `peak_positions * position_size` |
| `rotated_out_total` / `rotated_out_rate` | Trades closed via rotation |
| `capacity_skip_total` | Candidates skipped due to full capacity |
| `duplicate_skip_total` | Candidates skipped due to duplicate ticker |

---

## 9. Validation & Experiments

### Walk-Forward Validation (`walk_forward.py`)

Expanding-window validation to detect overfitting. **Independent mode only.**

- Candidates are sorted by `report_date` and grouped into unique months.
- The last `n_folds` months (configurable via `--wf-folds`, default 3) become individual test periods.
- Each fold expands the training window: Fold 1 trains on months `[1..N]`, tests on `[N+1]`; Fold 2 trains on `[1..N+1]`, tests on `[N+2]`; etc.
- Overfitting score = `mean(test_sharpe / train_sharpe)` across folds (folds with `train_sharpe == 0` are excluded).
- Threshold: score >= 0.5 → PASS (low overfitting risk).
- Out-of-sample (OOS) pooled metrics are computed from all test-fold trades combined.

### Trailing Stop Experiment (`trailing_stop_experiment.py`)

Grid search over trailing stop parameters using the same candidate set:

| Parameter | Values Tested |
|-----------|---------------|
| EMA period | 5, 10, 20 |
| N-week low period | 2, 4, 8 |
| Transition weeks | configurable per run |

Outputs a formatted comparison table and CSV with metrics for each configuration plus an optional baseline (no trailing stop, 90-day max holding).

### Stop Loss Mode Experiment (`stop_loss_experiment.py`)

Compares all 4 stop loss modes (`intraday`, `close`, `skip_entry_day`, `close_next_open`) on an identical candidate set. Outputs a side-by-side comparison table.

Usage:
```bash
# Trailing stop experiment
python -m backtest.trailing_stop_experiment --reports-dir reports/ \
    --data-end-date 2026-02-14 --include-baseline --include-nweek

# Stop loss mode experiment
python -m backtest.stop_loss_experiment --reports-dir reports/
```

---

## 10. Reproducibility

### run_manifest.json

Written after each backtest run to the output directory. Contains:

| Section | Fields |
|---------|--------|
| Environment | `timestamp` (UTC ISO), `git_sha`, `git_dirty`, `python_version` |
| Configuration | Full CLI `config` dict (all parameters) |
| Data | `candidate_count`, `trade_count`, `skipped_count` |
| Results | `summary_metrics` (total_trades, win_rate, total_pnl, profit_factor, trade_sharpe, max_drawdown) |

### Live System Alignment

`LiveConfig.verify_against_manifest()` in `live/config.py` performs a **subset field check** against the manifest. It compares only the 8 fields listed in `MANIFEST_FIELD_MAP`:

| Manifest Key | LiveConfig Attribute |
|-------------|---------------------|
| `position_size` | `position_size` |
| `stop_loss` | `stop_loss_pct` |
| `slippage` | `slippage_pct` |
| `max_holding` | `max_holding_days` |
| `stop_mode` | `stop_mode` |
| `entry_mode` | `entry_mode` |
| `max_positions` | `max_positions` |
| `trailing_transition_weeks` | `trailing_transition_weeks` |

This ensures that the critical trading parameters match between backtested and live configurations, without requiring all parameters (e.g., filter thresholds) to be identical.

---

## 11. CLI Reference

### Main Backtest (`python -m backtest.main`)

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `--reports-dir` | str | `reports/` | Directory with earnings trade HTML reports |
| `--output-dir` | str | `reports/backtest/` | Output directory for results |
| `--position-size` | float | 10000 | Position size per trade ($) |
| `--stop-loss` | float | 10.0 | Stop loss percentage |
| `--slippage` | float | 0.5 | Slippage percentage on stop |
| `--max-holding` | int | 90 | Max holding period (calendar days) |
| `--min-grade` | choice | D | Minimum grade to include (A/B/C/D) |
| `--min-score` | float | None | Minimum score filter (inclusive) |
| `--max-score` | float | None | Maximum score filter (exclusive) |
| `--min-gap` | float | None | Minimum gap % filter (inclusive) |
| `--max-gap` | float | None | Maximum gap % filter (exclusive) |
| `--stop-mode` | choice | intraday | Stop loss mode: `intraday`, `close`, `skip_entry_day`, `close_next_open` |
| `--daily-entry-limit` | int | None | Max new entries per day (None = unlimited) |
| `--entry-mode` | choice | report_open | Entry timing: `report_open` or `next_day_open` |
| `--trailing-stop` | choice | None | Trailing stop mode: `weekly_ema` or `weekly_nweek_low` |
| `--trailing-ema-period` | int | 10 | Weekly EMA period for trailing stop |
| `--trailing-nweek-period` | int | 4 | N-week low period for trailing stop |
| `--trailing-transition-weeks` | int | 3 | Completed weeks before trailing stop activates |
| `--disable-max-holding` | flag | false | Disable max holding period (requires `--trailing-stop`) |
| `--data-end-date` | str | None | Backtest end date YYYY-MM-DD (positions closed at this date) |
| `--fmp-api-key` | str | None | FMP API key (overrides env/config) |
| `--parse-only` | flag | false | Only parse HTML, skip simulation |
| `--walk-forward` | flag | false | Run walk-forward validation |
| `--wf-folds` | int | 3 | Number of walk-forward folds |
| `--charts` | flag | false | Generate candlestick chart PNGs |
| `--max-positions` | int | None | Max concurrent positions (enables portfolio mode) |
| `--no-rotation` | flag | false | Disable position rotation (requires `--max-positions`) |
| `--verbose` / `-v` | flag | false | Verbose logging |

### Experiment CLIs

```bash
# Trailing stop sensitivity analysis
python -m backtest.trailing_stop_experiment \
    --reports-dir reports/ \
    --data-end-date 2026-02-14 \
    --include-baseline \
    --include-nweek

# Stop loss mode comparison
python -m backtest.stop_loss_experiment \
    --reports-dir reports/ \
    --stop-loss 10.0 \
    --entry-mode report_open
```
